<!doctype html>
<html style="margin:0; padding:0; border:0; width:100%; height:100%;">

<head>
  <title>Pac Man - Retro re-make by Jonathan Markland</title>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="fable.ico" />
</head>

<body style="margin:0; padding:0; border:0; width:100%; height:100%; overflow:hidden; background-color:#000;">

	<style>
		.hidden { display:none; }
		.centre { overflow:hidden; align-self:center; justify-self:center; }
		.loader { background-color:#DCDBAF; padding:1em; }
		.canvas { height:100%; image-rendering: pixelated; }
	</style>

    <!-- Game play canvas -->

    <div style="display:grid; width:100%; height:100%;">
        
		<div id="loaderScreen" class="centre loader">
			Loading game files, then game will start...
		</div>

		<canvas id="gameScreen" width="320" height="256" class="centre canvas hidden">
            Web Canvas isn't supported by this browser, so the game cannot be displayed.
        </canvas>
		
    </div>

    <!-- Supplementary scripts could possibly be done in F# itself through Fable -->

    <script>

        function setMagentaToAlphaZero(imgElement) {

            const imgWidth = imgElement.width;
            const imgHeight = imgElement.height;

            var canvas = document.createElement('canvas');
            canvas.setAttribute('width', imgWidth);
            canvas.setAttribute('height', imgHeight);

            var context2d = canvas.getContext('2d');
            context2d.drawImage(imgElement, 0, 0);

            var imageData = context2d.getImageData(0, 0, imgWidth, imgHeight);
            var data = imageData.data;

            const dataLength = data.length;

            for (var i = 0; i < dataLength; i += 4) {
                if (data[i] === 0xFF && data[i + 1] === 0x00 && data[i + 2] === 0xFF) {
                    data[i + 3] = 0;
                }
            }

            context2d.putImageData(imageData, 0, 0);
            return canvas;
        }

        function loadImageThenDo(fileName, needsMagentaColourKey, onCompletionOfLoad) {

            var img = new Image();
            img.src = "Images/" + fileName;

            console.log('Trying to load image ' + img.src);

            img.onload = function () { // TODO: What do we do when this DOESN'T get called?
                console.log('Successfully loaded: ' + img.src);
                if (needsMagentaColourKey) {
                    onCompletionOfLoad(setMagentaToAlphaZero(img));
                    console.log('Successfully applied magenta colour key for image: ' + img.src);
                }
                else {
                    onCompletionOfLoad(img);
                }
            }
        }

    </script>

    <!-- F# transpiled to Javascript using Fable -->

    <script src="bundle.js"></script>

</body>
</html>