<!doctype html>
<html style="margin:0; padding:0; border:0; width:100%; height:100%;">

<head>
  <title>Fort Assault - Retro re-make by Jonathan Markland</title>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="fable.ico" />
</head>

<body style="margin:0; padding:0; border:0; width:100%; height:100%; overflow:hidden; background-color:#222222;">

    <!-- Game play canvas -->

    <div style="display:grid; width:100%; height:100%;">
        <canvas id="gameScreen"
                width="320" height="200"
                style="overflow:hidden; align-self:center; justify-self:center; width:80%; image-rendering: pixelated;">
            Web Canvas isn't supported by this browser, so the game cannot be displayed.
        </canvas>
    </div>

    <!-- Supplementary scripts could possibly be done in F# itself through Fable -->

    <script>

        function setMagentaToAlphaZero(imgElement) {

            const imgWidth = imgElement.width;
            const imgHeight = imgElement.height;

            var canvas = document.createElement('canvas');
            canvas.setAttribute('width', imgWidth);
            canvas.setAttribute('height', imgHeight);

            var context2d = canvas.getContext('2d');
            context2d.drawImage(imgElement, 0, 0);

            var imageData = context2d.getImageData(0, 0, imgWidth, imgHeight);
            var data = imageData.data;

            const dataLength = data.length;

            for (var i = 0; i < dataLength; i += 4) {
                if (data[i] === 0xFF && data[i + 1] === 0x00 && data[i + 2] === 0xFF) {
                    data[i + 3] = 0;
                }
            }

            context2d.putImageData(imageData, 0, 0);
            return canvas;
        }

        function myFunction() {

            const canvas = document.getElementById('gameScreen');
            const ctx = canvas.getContext('2d');

            //ctx.fillStyle = 'green';
            //ctx.fillRect(10, 10, 100, 100);

            const imgVictoryScreen = document.getElementById('imgVictoryScreen');
            const imgTankFacingLeft0 = setMagentaToAlphaZero(document.getElementById('imgTankFacingLeft0'));
            ctx.drawImage(imgVictoryScreen, 0, 0);
            ctx.drawImage(imgTankFacingLeft0, 160, 100);
        }

        function loadImageThenDo(fileName, needsMagentaColourKey, onCompletionOfLoad) {
            var img = new Image();
            img.src = "Images/" + fileName;
            console.log('Trying to load image ' + img.src);
            img.onload = function () { // TODO: What do we do when this DOESN'T get called?
                console.log('Successfully loaded: ' + img.src);
                if (needsMagentaColourKey) {
                    onCompletionOfLoad(setMagentaToAlphaZero(img));
                    console.log('Successfully applied magenta colour key for image: ' + img.src);
                }
                else {
                    onCompletionOfLoad(img);
                }
            }
        }

    </script>

    <!-- F# transpiled to Javascript using Fable -->

    <script src="bundle.js"></script>

</body>
</html>